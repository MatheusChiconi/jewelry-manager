{% extends 'base.html' %}
{% load static %}

{% block title %}Consultar Inventário{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/produtos/produto_consultar.css' %}">
{% endblock %}

{% block content %}
<main class="container py-5">
    <!-- Título da Página -->
    <div class="page-header text-center mb-5">
        <h1 class="display-5 fw-bold">Inventário de Produtos</h1>
        <p class="lead text-muted">Consulte, filtre e gerencie todas as peças do seu estoque.</p>
    </div>

    <!-- =================================================================
    EXIBIÇÃO DE MENSAGENS DO DJANGO (Ex: "Produto excluído com sucesso")
    ================================================================== -->
    {% if messages %}
        <div class="messages mb-4">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Barra de Busca e Filtros (sem alterações) -->
    <div class="card shadow-sm mb-4 filter-card">
        <div class="card-body">
            <form class="row g-3 align-items-end" method="GET">
                <div class="col-lg-6 col-md-12">
                    <label for="search-input" class="form-label">Buscar por Nome ou Código</label>
                    <input type="text" class="form-control" id="search-input" name="buscar" placeholder="Digite para buscar..." value="{{ termo_busca_valor }}">
                </div>
                <div class="col-lg-3 col-md-6">
                    <label for="filter-tipo" class="form-label">Filtrar por Tipo</label>
                    <select class="form-select" id="filter-tipo" name="tipo">
                        <option value="">Todos os tipos</option>
                        <option value="OU" {% if filtro_tipo_valor == 'OU' %}selected{% endif %}>Ouro</option>
                        <option value="PR" {% if filtro_tipo_valor == 'PR' %}selected{% endif %}>Prata</option>
                        <option value="FO" {% if filtro_tipo_valor == 'FO' %}selected{% endif %}>Folheado</option>
                    </select>
                </div>
                <div class="col-lg-3 col-md-6">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search me-2"></i>Filtrar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabela de Produtos -->
    <div class="card shadow-sm table-container">
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0">
                <thead class="table-dark">
                    <tr>
                        <th scope="col">Nome do Produto</th>
                        <th scope="col">Material</th>
                        <th scope="col">Tipo da Peça</th>
                        <th scope="col">Fornecedor</th> <!-- ADICIONADO -->
                        <th scope="col" class="text-center">Estoque</th>
                        <th scope="col" class="text-end">Preço de Venda</th>
                        <th scope="col" class="text-center">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for produto in produtos %}
                    <tr class="product-row">
                        <td>
                            <div class="fw-bold">{{ produto.nome }}</div>
                            <small class="text-muted">Cód: {{ produto.codigo_barras }}</small>
                        </td>
                        <td>
                            {% if produto.tipo == 'OU' %}
                                <span class="badge bg-warning text-dark">{{ produto.get_tipo_display }}</span>
                            {% elif produto.tipo == 'PR' %}
                                <span class="badge bg-info">{{ produto.get_tipo_display }}</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ produto.get_tipo_display }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if produto.tipo_peca %}
                                <span class="badge bg-success">{{ produto.tipo_peca }}</span>
                            {% else %}
                                <span class="badge bg-light text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if produto.fornecedor %}
                                <span class="badge bg-primary">{{ produto.fornecedor }}</span>
                            {% else %}
                                <span class="badge bg-light text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-center">{{ produto.estoque }}</td>
                        <td class="text-end fw-bold">R$ {{ produto.preco_venda }}</td>
                        <td class="text-center">
                            <a href="#" class="btn btn-sm btn-outline-secondary" title="Imprimir Etiqueta"><i class="fas fa-barcode"></i></a>
                            <form action="{% url 'deletar_produto' produto.id %}" method="POST" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline-danger btn-delete" title="Excluir">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <h5 class="mb-3">Nenhum produto encontrado</h5>
                            <p class="text-muted">Tente ajustar os termos da sua busca.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Link para Voltar -->
    <div class="text-center mt-5 back-link-container">
        <a href="{% url 'produto_home' %}" class="text-muted text-decoration-none back-link">
            <i class="fas fa-arrow-left me-2"></i>Voltar para o painel de produtos
        </a>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/produtos/produto_consultar.js' %}"></script>
{% endblock %}